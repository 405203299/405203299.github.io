<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Writing Tests - Linera</title>


        <!-- Custom HTML head -->
        
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../introduction.html">The Linera Developer Manual</a></li><li class="chapter-item expanded "><a href="../getting_started.html"><strong aria-hidden="true">1.</strong> Getting Started</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../getting_started/installation.html"><strong aria-hidden="true">1.1.</strong> Installation</a></li><li class="chapter-item expanded "><a href="../getting_started/hello_linera.html"><strong aria-hidden="true">1.2.</strong> Hello, Linera</a></li></ol></li><li class="chapter-item expanded "><a href="../core_concepts.html"><strong aria-hidden="true">2.</strong> The Linera Protocol</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../core_concepts/overview.html"><strong aria-hidden="true">2.1.</strong> Overview</a></li><li class="chapter-item expanded "><a href="../core_concepts/microchains.html"><strong aria-hidden="true">2.2.</strong> Microchains</a></li><li class="chapter-item expanded "><a href="../core_concepts/wallets.html"><strong aria-hidden="true">2.3.</strong> Wallets</a></li><li class="chapter-item expanded "><a href="../core_concepts/node_service.html"><strong aria-hidden="true">2.4.</strong> Node Service</a></li><li class="chapter-item expanded "><a href="../core_concepts/applications.html"><strong aria-hidden="true">2.5.</strong> Applications</a></li></ol></li><li class="chapter-item expanded "><a href="../sdk.html"><strong aria-hidden="true">3.</strong> Writing Linera Applications</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../sdk/creating_a_project.html"><strong aria-hidden="true">3.1.</strong> Creating a Project</a></li><li class="chapter-item expanded "><a href="../sdk/state.html"><strong aria-hidden="true">3.2.</strong> Creating the Application State</a></li><li class="chapter-item expanded "><a href="../sdk/abi.html"><strong aria-hidden="true">3.3.</strong> Defining the ABI</a></li><li class="chapter-item expanded "><a href="../sdk/contract.html"><strong aria-hidden="true">3.4.</strong> Writing the Contract Binary</a></li><li class="chapter-item expanded "><a href="../sdk/service.html"><strong aria-hidden="true">3.5.</strong> Writing the Service Binary</a></li><li class="chapter-item expanded "><a href="../sdk/deploy.html"><strong aria-hidden="true">3.6.</strong> Deploying the Application</a></li><li class="chapter-item expanded "><a href="../sdk/messages.html"><strong aria-hidden="true">3.7.</strong> Cross-Chain Messages</a></li><li class="chapter-item expanded "><a href="../sdk/composition.html"><strong aria-hidden="true">3.8.</strong> Calling other Applications</a></li><li class="chapter-item expanded "><a href="../sdk/logging.html"><strong aria-hidden="true">3.9.</strong> Printing Logs from an Application</a></li><li class="chapter-item expanded "><a href="../sdk/testing.html" class="active"><strong aria-hidden="true">3.10.</strong> Writing Tests</a></li></ol></li><li class="chapter-item expanded "><a href="../advanced_topics.html"><strong aria-hidden="true">4.</strong> Advanced Topics</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../advanced_topics/views.html"><strong aria-hidden="true">4.1.</strong> Views</a></li><li class="chapter-item expanded "><a href="../advanced_topics/persistent_storage.html"><strong aria-hidden="true">4.2.</strong> Persistent Storage</a></li><li class="chapter-item expanded "><a href="../advanced_topics/validators.html"><strong aria-hidden="true">4.3.</strong> Validators</a></li><li class="chapter-item expanded "><a href="../advanced_topics/block_creation.html"><strong aria-hidden="true">4.4.</strong> Creating New Blocks</a></li></ol></li><li class="chapter-item expanded "><a href="../appendix/glossary.html"><strong aria-hidden="true">5.</strong> Appendix</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../appendix/glossary.html"><strong aria-hidden="true">5.1.</strong> Glossary</a></li><li class="chapter-item expanded "><a href="../videos.html"><strong aria-hidden="true">5.2.</strong> Videos</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Linera</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <!-- Page table of contents -->
                        <div class="sidetoc"><nav class="pagetoc"></nav></div>

                        <h1 id="310-writing-tests"><a class="header" href="#310-writing-tests">3.10. Writing Tests</a></h1>
<p>Linera applications can be tested using unit tests or integration tests. Both are a bit different than usual Rust tests. Unit tests are executed inside a WebAssembly virtual machine in an environment that simulates a single microchain and a single application. System APIs are only available if they are mocked using helper functions from <code>linera_sdk::test</code>.</p>
<p>Integration tests run outside a WebAssembly virtual machine, and use a simulated validator for testing. This allows creating chains and adding blocks to them in order to test interactions between multiple microchains and multiple applications.</p>
<p>Applications should consider having both types of tests. Unit tests should be used to focus on the application's internals and core functionality. Integration tests should be used to test how the application behaves on a more complex environment that's closer to the real network.</p>
<blockquote>
<p>In most cases, the simplest way to run both unit tests and integration tests is to call <code>linera project test</code> from the project's directory.</p>
</blockquote>
<h2 id="unit-tests"><a class="header" href="#unit-tests"><a href="https://linera.dev/sdk/testing.html#unit-tests">Unit tests</a></a></h2>
<p>Unit tests are written beside the application's source code (i.e., inside the <code>src</code> directory of the project). There are several differences to normal Rust unit tests:</p>
<ul>
<li>the target <code>wasm32-unknown-unknown</code> must be selected;</li>
<li>the custom test runner <code>linera-wasm-test-runner</code> must be used;</li>
<li>the <a href="https://docs.rs/webassembly-test/latest/webassembly_test/"><code>#[webassembly_test\]</code></a> attribute must be used instead of the usual <code>#[test]</code> attribute.</li>
</ul>
<p>The first two items are done automatically by <code>linera project test</code>.</p>
<p>Alternatively, one may set up the environment and run <code>cargo test</code> directly as described <a href="https://linera.dev/sdk/testing.html#manually-configuring-the-environment">below</a>.</p>
<h3 id="example"><a class="header" href="#example"><a href="https://linera.dev/sdk/testing.html#example">Example</a></a></h3>
<p>A simple unit test is shown below, which tests if the application's <code>do_something</code> method changes the application state.</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>#[cfg(test)]
mod tests {
    use crate::state::ApplicationState;
    use webassembly_test::webassembly_test;

    #[webassembly_test]
    fn test_do_something() {
        let mut application = ApplicationState {
            // Configure the application's initial state
            ..ApplicationState::default()
        };

        let result = application.do_something();

        assert!(result.is_ok());
        assert_eq!(application, ApplicationState {
            // Define the application's expected final state
            ..ApplicationState::default()
        });
    }
}
<span class="boring">}</span></code></pre></pre>
<h3 id="mocking-system-apis"><a class="header" href="#mocking-system-apis"><a href="https://linera.dev/sdk/testing.html#mocking-system-apis">Mocking System APIs</a></a></h3>
<p>Unit tests run in a constrained environment, so things like access to the key-value store, cross-chain messages and cross-application calls can't be executed. However, they can be simulated using mock APIs. The <code>linera-sdk::test</code> module provides some helper functions to mock the system APIs.</p>
<p>Here's an example mocking the key-value store.</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>#[cfg(test)]
mod tests {
    use crate::state::ApplicationState;
    use linera_sdk::test::mock_key_value_store;
    use webassembly_test::webassembly_test;

    #[webassembly_test]
    fn test_state_is_not_persisted() {
        let mut storage = mock_key_value_store();

        // Assuming the application uses views
        let mut application = ApplicationState::load(storage.clone())
            .now_or_never()
            .expect("Mock key-value store returns immediately")
            .expect("Failed to load view from mock key-value store");

        // Assuming `do_something` changes the view, but does not persist it
        let result = application.do_something();

        assert!(result.is_ok());

        // Check that the state in memory is different from the state in storage
        assert_ne!(application, ApplicatonState::load(storage));
    }
}
<span class="boring">}</span></code></pre></pre>
<h3 id="running-unit-tests-with-cargo-test"><a class="header" href="#running-unit-tests-with-cargo-test"><a href="https://linera.dev/sdk/testing.html#running-unit-tests-with-cargo-test">Running Unit Tests with <code>cargo test</code></a></a></h3>
<p>Running <code>linera project test</code> is easier, but if there's a need to run <code>cargo test</code> explicitly to run the unit tests, Cargo must be configured to use the custom test runner <code>linera-wasm-test-runner</code>. This binary can be built from the repository or installed with <code>cargo install linera-sdk</code>.</p>
<pre><code class="language-bash">cd linera-protocol
cargo build -p linera-sdk --bin linera-wasm-test-runner --release
</code></pre>
<p>The steps above build the <code>linera-wasm-test-runner</code> and places the resulting binary at <code>linera-protocol/target/release/linera-wasm-test-runner</code>.</p>
<p>With the binary available, the last step is to configure Cargo. There are a few ways to do this. A quick way is to set the <code>CARGO_TARGET_WASM32_UNKNOWN_UNKNOWN_RUNNER</code> environment variable to the path of the binary.</p>
<p>A more persistent way is to change one of <a href="https://doc.rust-lang.org/cargo/reference/config.html#hierarchical-structure">Cargo's configuration files</a>. As an example, the following file can be placed inside the project's directory at <code>PROJECT_DIR/.cargo/config.toml</code>:</p>
<pre><code class="language-ignore">[target.wasm32-unknown-unknown]
runner = "PATH_TO/linera-wasm-test-runner"
</code></pre>
<p>After configuring the test runner, unit tests can be executed with</p>
<pre><code class="language-bash">cargo test --target wasm32-unknown-unknown
</code></pre>
<p>Optionally, <code>wasm32-unknown-unknown</code> can be made the default build target with the following lines in <code>PROJECT_DIR/.cargo/config.toml</code>:</p>
<pre><code class="language-ignore">[build]
target = "wasm32-unknown-unknown"
</code></pre>
<h2 id="integration-tests"><a class="header" href="#integration-tests"><a href="https://linera.dev/sdk/testing.html#integration-tests">Integration Tests</a></a></h2>
<p>Integration tests are usually written separately from the application's source code (i.e., inside a <code>tests</code> directory that's beside the <code>src</code> directory).</p>
<p>Integration tests are normal Rust integration tests, and they are compiled to the <strong>host</strong> target instead of the <code>wasm32-unknown-unknown</code> target used for unit tests. This is because unit tests run inside a WebAssembly virtual machine and integration tests run outside a virtual machine, starting isolated virtual machines to run each operation of each block added to each chain.</p>
<blockquote>
<p>Integration tests can be run with <code>linera project test</code> or simply <code>cargo test</code>.</p>
</blockquote>
<p>If you wish to use <code>cargo test</code> and have overridden your default target to be in <code>wasm32-unknown-unknown</code> in <code>.cargo/config.toml</code>, you will have to pass a native target to <code>cargo</code>, for instance <code>cargo test --target aarch64-apple-darwin</code>.</p>
<p>Integration tests use the helper types from <code>linera_sdk::test</code> to set up a simulated Linera network, and publish blocks to microchains in order to execute the application.</p>
<h3 id="example-1"><a class="header" href="#example-1"><a href="https://linera.dev/sdk/testing.html#example-1">Example</a></a></h3>
<p>A simple test that sends a message between application instances on different chains is shown below.</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>#[tokio::test]
async fn test_cross_chain_message() {
    let (validator, application_id) = TestValidator::with_current_application(vec![], vec![]).await;

    let mut sender_chain = validator.get_chain(application_id.creation.chain_id).await;
    let mut receiver_chain = validator.new_chain().await;

    sender_chain
        .add_block(|block| {
            block.with_operation(
                application_id,
                Operation::SendMessageTo(receiver_chain.id()),
            )
        })
        .await;

    receiver_chain.handle_received_messages().await;

    assert_eq!(
        receiver_chain
            .query::&lt;ChainId&gt;(application_id, Query::LastSender)
            .await,
        sender_chain.id(),
    );
}
<span class="boring">}</span></code></pre></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../sdk/logging.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="../advanced_topics.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../sdk/logging.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="../advanced_topics.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script type="text/javascript">
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>

        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->


    </body>
</html>
